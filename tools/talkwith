#!/bin/sh
# 
# talkwith -- switches speakup synthesizers on the fly
# and saves or loads speakup parameters
# 
# Copyright (c) 2009 by  the Speakup Team
# Copyright (c) 2008, 2009 by  Charles Hallenbeck
# 
#  This program is free software: you can redistribute it and/or modify
#  it under the terms of the GNU General Public License as published by
#  the Free Software Foundation, either version 2 of the License, or
#  (at your option) any later version.
#
#   This program is distributed in the hope that it will be useful,
#   but WITHOUT ANY WARRANTY; without even the implied warranty of
#   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#   GNU General Public License for more details.
#
#  You should have received a copy of the GNU General Public License
#   along with this program.  If not, see <http://www.gnu.org/licenses/>.
#
# Requirements: Linux speakup 3.1.0 or later
#
# To install, copy this script to a directory on the execution path
# e.g. /usr/sbin, or /usr/local/sbin.
# This script should be run as root.

# Define some variables
SPEAKUPDIR="/sys/accessibility/speakup"
CONFDIR="/etc/speakup"

# be sure we are root
if [ $(id -ru) -gt "0" ]; then
	echo "`basename $0` must be run as root."
	exit
fi

# make sure speakup is loaded
if [ ! -d $SPEAKUPDIR ]; then
	echo "Speakup does not seem to be installed."
	exit
fi

# Check the command line for options
if [ "$1" = "-n" ]; then
	NOCONF="y"
	shift
fi

if [ "$1" = "" ]; then
	echo
	echo "Usage: `basename $0` [-n] <synth> [ options ]"
	echo
	echo "If the synth name is espeak or spd, the option following "
	echo "the name is simply passed along to espeakup or speechd-up."
	echo
	echo "Talkwith does not install or remove modules, so make sure any"
	echo "required driver modules are installed before running talkwith."
	echo "The correct driver for espeak and spd is speakup_soft."
	echo
	echo "If the -n option is used, speakupconf will not be called"
	echo " to load parameters."
	echo
	echo "You may select a synth name from the following list:"
	echo "acntsa, acntpc, apollo, audptr, bns, dectlk, decext, decpc, dtlk,"
	echo "espeak, keypc, ltlk, spd, spkout, txprt, dummy, or none."
	echo
	exit
fi
 
OLDMOD="`cat $SPEAKUPDIR/synth`"
NEWMOD=$1
if [ "$NEWMOD" = "espeak" ] || [ "$NEWMOD" = "spd" ]; then
	if [ "$NEWMOD" = "espeak" ] && [ ! `which espeakup` ]; then
		echo "espeakup does not seem to be available."
		exit
	elif [ "$NEWMOD" = "spd" ] && [ ! `which speechd-up` ]; then
		echo "speechd-up does not seem to be available."
		exit
	fi
	NEWMOD="soft"
fi

if [ "$OLDMOD" = "soft" ]; then
	if pidof espeakup >/dev/null 2>&1; then
		OLDVOX=espeak
	else
		OLDVOX=spd
	fi
else
	OLDVOX=$OLDMOD
fi
NEWVOX=$1
shift

echo "$NEWMOD" > $SPEAKUPDIR/synth 2> /dev/null

# Did the switch succeed?
if [ $? != 0 ]; then
	echo "Unable to switch to the $NEWMOD synthesizer."
	echo "This means that the driver is not built in, the module"
	echo "is not loaded, or $NEWMOD is not a valid synthesizer."
	exit 1
fi

if [ "$OLDMOD" = "soft" ]; then
	if [ -f /var/run/speechd-up.pid ]; then
		kill -TERM `cat /var/run/speechd-up.pid` 2> /dev/null
	elif [ -f /var/run/espeakup.pid ]; then
		kill -TERM `cat /var/run/espeakup.pid` 2> /dev/null
	fi
fi
sleep 2
if [ "$NEWVOX" = "none" ]; then
	exit
fi
if [ "$NEWVOX" = "espeak" ]; then
	espeakup $* >/dev/null 2>&1
elif [ "$NEWVOX" = "spd" ]; then
	nice -n 5 speechd-up $* 2>/dev/null
fi

# Load synth specific parameters
if [ -z "$NOCONF"  -a -d $CONFDIR ]; then
	speakupconf load
fi
