#!/bin/bash
# Installs speakup to kernel sources
# Usage: ./install <KERNELDIR>

die() {
	echo $*
	exit 1
}

apply() {
	patch -N -b -p1 -l -d $2 -i $1
	if [ ! $? ]; then
		die "Unable to apply $1 to $2"
	fi
}

KDIR=${1:-/usr/src/linux}
SPKDIR=$(pwd)
PATCHFILES=" /drivers/char/Makefile /drivers/char/consolemap.c \
	/drivers/char/keyboard.c /drivers/char/vt.c \
	/drivers/Kconfig /drivers/Makefile \
/include/linux/keyboard.h"

if [ ! -d ${KDIR} ]; then
	die "${KDIR} is not a directory"
fi

if [ ! -e ${KDIR}/MAINTAINERS ]; then
	die "${KDIR} is not a kernel dir"
fi

SPEAKUP_INSTALLED=0
for FILE in $PATCHFILES; do
	if [ ! -f ${KDIR}${FILE}.orig ]; then
		SPEAKUP_INSTALLED=1
	fi
done

if [ SPEAKUP_INSTALLED ]; then
	echo Re-installing speakup to ${KDIR}
	for FILE in $PATCHFILES; do
		mv -f ${KDIR}${FILE}.orig ${KDIR}${FILE}
	done
	rm -rf ${KDIR}/drivers/char/speakup ${KDIR}/Documentation/speakup
fi

apply $SPKDIR/patches/kernel-integration-2.6.24.patch ${KDIR}

cp -R ${SPKDIR}/src ${KDIR}/drivers/char/speakup
cp -R ${SPKDIR}/doc ${KDIR}/Documentation/speakup
echo "speakup has been installed  to ${KDIR}"
